semantic_models:
  - name: orders
    description: >
      Semantic model for order analysis. This model enables consistent metric 
      definitions for revenue, delivery performance, and customer satisfaction 
      across all downstream analytics and BI tools.

    model: ref('fct_orders')

    defaults:
      agg_time_dimension: order_date

    # Primary entity - the grain of the model
    entities:
      - name: order
        type: primary
        expr: order_id

      - name: customer
        type: foreign
        expr: customer_key

    # Dimensions - attributes to slice and dice by
    dimensions:
      # Time dimension
      - name: order_date
        type: time
        type_params:
          time_granularity: day
        expr: order_purchase_timestamp
        description: The timestamp when the order was placed.

      - name: delivery_date
        type: time
        type_params:
          time_granularity: day
        expr: order_delivered_customer_date
        description: The timestamp when the order was delivered to customer.

      # Categorical dimensions
      - name: order_status
        type: categorical
        expr: order_status
        description: Current status of the order (delivered, shipped, canceled, etc.).

      - name: primary_payment_type
        type: categorical
        expr: primary_payment_type
        description: The payment method used for the highest value payment.

      - name: customer_state
        type: categorical
        expr: customer_unique_id
        description: Unique identifier for the customer.

      # Boolean dimensions (for filtering)
      - name: is_delivered
        type: categorical
        expr: is_delivered
        description: Whether the order was delivered.

      - name: is_on_time
        type: categorical
        expr: is_on_time
        description: Whether the order was delivered on or before the estimated date.

      - name: is_perfect_order
        type: categorical
        expr: is_perfect_order
        description: Whether the order was delivered on-time with a good review (4+).

    # Measures - aggregatable numeric values
    measures:
      # Count measures
      - name: order_count
        agg: count
        expr: order_id
        description: Count of orders.
        create_metric: true

      - name: delivered_order_count
        agg: count
        expr: "case when is_delivered then order_id end"
        description: Count of delivered orders.
        create_metric: true

      - name: perfect_order_count
        agg: count
        expr: "case when is_perfect_order then order_id end"
        description: Count of perfect orders (delivered, on-time, good review).
        create_metric: true

      # Revenue measures
      - name: total_revenue
        agg: sum
        expr: order_total_value
        description: Total order value including items and freight.
        create_metric: true

      - name: items_revenue
        agg: sum
        expr: order_items_value
        description: Total revenue from items only (excludes freight).
        create_metric: true

      - name: freight_revenue
        agg: sum
        expr: order_freight_value
        description: Total freight/shipping revenue.
        create_metric: true

      - name: payment_value
        agg: sum
        expr: order_payment_value
        description: Total payment value received.
        create_metric: true

      - name: average_order_value
        agg: average
        expr: order_total_value
        description: Average order value.
        create_metric: true

      # Item measures
      - name: total_items
        agg: sum
        expr: order_items_count
        description: Total number of items sold.
        create_metric: true

      - name: unique_products_sold
        agg: sum
        expr: unique_products_count
        description: Total unique products across orders.

      - name: unique_sellers_involved
        agg: sum
        expr: unique_sellers_count
        description: Total unique sellers across orders.

      # Review measures
      - name: average_review_score
        agg: average
        expr: review_score
        description: Average customer review score (1-5).
        create_metric: true

      - name: orders_with_reviews
        agg: count
        expr: "case when review_score is not null then order_id end"
        description: Count of orders that received a review.

      # Delivery performance measures
      - name: on_time_deliveries
        agg: count
        expr: "case when is_on_time then order_id end"
        description: Count of orders delivered on or before estimated date.

      - name: average_delivery_days
        agg: average
        expr: delivery_time_days
        description: Average number of days from purchase to delivery.
        create_metric: true

      - name: average_approval_hours
        agg: average
        expr: approval_time_hours
        description: Average hours from purchase to payment approval.

      - name: average_processing_hours
        agg: average
        expr: processing_time_hours
        description: Average hours from approval to carrier handover.

      - name: average_shipping_hours
        agg: average
        expr: shipping_time_hours
        description: Average hours from carrier pickup to customer delivery.
